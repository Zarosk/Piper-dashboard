<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Production Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .dashboard-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }
        
        .dashboard-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .security-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 12px;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .security-status {
            color: #4ade80;
            font-weight: bold;
        }
        
        .session-timer {
            color: #fbbf24;
            font-weight: bold;
        }
        
        .session-warning {
            color: #f87171 !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #5a2d91);
        }
        
        .btn-small {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin: 2px;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        
        .btn-small.btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-small.btn-danger:hover {
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .summary-card.active {
            background: #e3f2fd;
            box-shadow: 0 4px 20px rgba(0,123,255,0.3);
        }
        
        .card-operational { border-left-color: #28a745; }
        .card-maintenance { border-left-color: #ffc107; }
        .card-grounded { border-left-color: #dc3545; }
        .card-inspection { border-left-color: #17a2b8; }
        .card-total { border-left-color: #6c757d; }
        
        .card-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-control {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .main-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1400px;
        }
        
        th {
            background: linear-gradient(135deg, #343a40, #495057);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-select {
            border: none;
            background: transparent;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            width: 130px;
        }
        
        .status-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        
        .status-select.production-ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-select.in-progress {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-select.on-hold {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-select.quality-check {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .priority-select {
            border: none;
            background: transparent;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            width: 80px;
        }
        
        .priority-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        
        .priority-select.critical {
            background-color: #dc3545;
            color: white;
        }
        
        .priority-select.high {
            background-color: #fd7e14;
            color: white;
        }
        
        .priority-select.medium {
            background-color: #ffc107;
            color: #000;
        }
        
        .priority-select.low {
            background-color: #28a745;
            color: white;
        }
        
        .table-input {
            border: none;
            background: transparent;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%;
        }
        
        .table-input:hover {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .table-input:focus {
            outline: none;
            background-color: white;
            border: 2px solid #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .notes-input {
            border: none;
            background: transparent;
            font-size: 11px;
            color: #666;
            padding: 2px 4px;
            border-radius: 3px;
            width: 100%;
            min-height: 40px;
            resize: vertical;
            font-family: inherit;
        }
        
        .notes-input:hover {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
        }
        
        .notes-input:focus {
            outline: none;
            background-color: white;
            border: 2px solid #007bff;
            box-shadow: 0 0 0 0.1rem rgba(0,123,255,.15);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            z-index: 1;
        }
        
        .operation-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transform: scale(1.2);
        }
        
        .operation-cell {
            text-align: center;
            padding: 8px;
        }
        
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .selected-row {
            background-color: #e3f2fd !important;
        }
        
        .selected-count {
            font-weight: bold;
            color: #6f42c1;
        }
        
        .hidden-row {
            display: none;
        }
        
        .overdue-row {
            background-color: #fff5f5 !important;
            border-left: 4px solid #dc3545 !important;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .completed-row {
            background-color: #f8fff9 !important;
            border-left: 4px solid #28a745 !important;
        }
        
        .critical-priority {
            border-left: 4px solid #dc3545 !important;
            background: linear-gradient(90deg, rgba(220,53,69,0.05) 0%, transparent 100%);
        }
        
        .high-priority {
            border-left: 4px solid #fd7e14 !important;
            background: linear-gradient(90deg, rgba(253,126,20,0.05) 0%, transparent 100%);
        }
        
        .completion-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .sortable-header:hover {
            background: linear-gradient(135deg, #495057, #6c757d) !important;
        }
        
        .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
            opacity: 0.7;
        }
        
        .sort-asc .sort-indicator:after {
            content: "‚ñ≤";
            color: #ffc107;
        }
        
        .sort-desc .sort-indicator:after {
            content: "‚ñº";
            color: #ffc107;
        }
        
        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .filter-chip {
            background: white;
            border: 2px solid #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .filter-chip:hover {
            border-color: #007bff;
            color: #007bff;
        }
        
        .filter-chip.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .filter-chip.status-production-ready.active {
            background: #28a745;
            border-color: #28a745;
        }
        
        .filter-chip.status-in-progress.active {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        
        .filter-chip.status-on-hold.active {
            background: #dc3545;
            border-color: #dc3545;
        }
        
        .filter-chip.status-quality-check.active {
            background: #17a2b8;
            border-color: #17a2b8;
        }
        
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            padding: 4px;
            margin-right: 8px;
            user-select: none;
            font-size: 14px;
            transition: color 0.2s ease;
        }
        
        .drag-handle:hover {
            color: #007bff;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
            color: #0056b3;
        }
        
        tr[draggable="true"]:hover .drag-handle {
            color: #007bff;
        }
        
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background-color: #e3f2fd !important;
        }
        
        .drag-over {
            border-top: 3px solid #007bff !important;
        }
        
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .security-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            animation: slide-in 0.3s ease-out;
        }
        
        @keyframes slide-in {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .security-warning {
            background: #dc3545 !important;
        }
        
        .input-invalid {
            border: 2px solid #dc3545 !important;
            background-color: #fff5f5 !important;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Screen lock overlay */
        .screen-locked {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .screen-locked::before {
            content: 'üîí Click anywhere to unlock';
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header h1 {
                font-size: 24px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .security-indicator {
                position: relative;
                text-align: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>Aircraft Production Dashboard</h1>
        <p>Real-time production monitoring and build status overview</p>
        <div class="security-indicator">
            üõ°Ô∏è <span class="security-status">Security: Active</span> | 
            Session: <span id="session-timer" class="session-timer">30:00</span>
        </div>
    </div>
    
    <div class="section">
        <h3>Bulk Operations</h3>
        <div style="margin-bottom: 15px;">
            <span class="selected-count" id="selected-count">0</span> aircraft selected
        </div>
        <div class="controls-grid">
            <button class="btn btn-purple" onclick="bulkUpdateStatus()" disabled>Update Status</button>
            <button class="btn btn-purple" onclick="bulkUpdatePriority()" disabled>Update Priority</button>
            <button class="btn btn-purple" onclick="bulkUpdateTeam()" disabled>Assign Team</button>
            <button class="btn btn-purple" onclick="copySelectedAircraft()" disabled>Copy Aircraft</button>
        </div>
    </div>
    
    <div class="section">
        <h3>Search & Filter Aircraft</h3>
        <div class="controls-grid">
            <input type="text" id="search-input" class="form-control" placeholder="üîç Search by Aircraft ID or Model">
            <select id="status-filter" class="form-control">
                <option value="">All Statuses</option>
                <option value="Production Ready">Production Ready</option>
                <option value="In Progress">In Progress</option>
                <option value="On Hold">On Hold</option>
                <option value="Quality Check">Quality Check</option>
            </select>
            <input type="text" id="team-filter" class="form-control" placeholder="Filter by Team">
            <select id="priority-filter" class="form-control">
                <option value="">All Priorities</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        
        <div class="quick-filters">
            <div class="filter-chip" onclick="toggleQuickFilter('status', 'Production Ready', this)">
                üü¢ Production Ready (<span id="quick-prod-ready">2</span>)
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('status', 'In Progress', this)">
                üü° In Progress (<span id="quick-in-progress">1</span>)
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('status', 'On Hold', this)">
                üî¥ On Hold (<span id="quick-on-hold">1</span>)
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('status', 'Quality Check', this)">
                üîµ Quality Check (<span id="quick-quality-check">1</span>)
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('priority', 'Critical', this)">
                ‚ö†Ô∏è Critical
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('priority', 'High', this)">
                üî∏ High Priority
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('date', 'overdue', this)">
                ‚è∞ Overdue
            </div>
            <div class="filter-chip" onclick="toggleQuickFilter('date', 'thisweek', this)">
                üìÖ Due This Week
            </div>
        </div>
        
        <button onclick="clearFilters()" class="btn">Clear All Filters</button>
    </div>
    
    <div class="section">
        <h3>Add New Aircraft</h3>
        <button class="btn" onclick="addNewAircraft()">‚ûï Add Aircraft</button>
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
            Click to add a new aircraft row to the dashboard
        </p>
    </div>
    
    <div class="section">
        <h3>Export Dashboard Data</h3>
        <button class="btn btn-info" onclick="exportToCSV()">üìä Download CSV</button>
        <button class="btn btn-success" onclick="copyTableData()">üìã Copy for Excel/Sheets</button>
        <button class="btn btn-purple" onclick="generatePDFReport()">üìÑ Generate PDF Report</button>
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
            CSV: Raw data export ‚Ä¢ Copy: Paste into Excel/Google Sheets ‚Ä¢ PDF: Professional summary report
        </p>
    </div>
    
    <div class="section">
        <h3>Data Management & Security</h3>
        <button class="btn btn-success" onclick="exportBackup()">üíæ Download Backup</button>
        <button class="btn btn-success" onclick="importBackup()">üì• Import Backup</button>
        <button class="btn btn-info" onclick="viewSecurityLog()">üõ°Ô∏è Security Log</button>
        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
            Backup: Save/restore encrypted data ‚Ä¢ Security: View audit trail ‚Ä¢ Auto-saves every 30 seconds
        </p>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card card-operational">
            <div class="card-number" style="color: #28a745;" id="prod-ready-count">2</div>
            <div class="card-label">Production Ready</div>
        </div>
        <div class="summary-card card-maintenance">
            <div class="card-number" style="color: #ffc107;" id="in-progress-count">1</div>
            <div class="card-label">In Progress</div>
        </div>
        <div class="summary-card card-grounded">
            <div class="card-number" style="color: #dc3545;" id="on-hold-count">1</div>
            <div class="card-label">On Hold</div>
        </div>
        <div class="summary-card card-inspection">
            <div class="card-number" style="color: #17a2b8;" id="quality-check-count">1</div>
            <div class="card-label">Quality Check</div>
        </div>
        <div class="summary-card card-total">
            <div class="card-number" style="color: #6c757d;" id="total-count">5</div>
            <div class="card-label">Total Units</div>
        </div>
    </div>
    
    <div class="main-table">
        <table>
            <thead>
                <tr>
                    <th><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" id="select-all" class="select-all-checkbox" /> Select</th>
                    <th class="sortable-header" onclick="sortTable('aircraft-id')">Aircraft ID <span class="sort-indicator"></span></th>
                    <th class="sortable-header" onclick="sortTable('model')">Model <span class="sort-indicator"></span></th>
                    <th class="sortable-header" onclick="sortTable('status')">Status <span class="sort-indicator"></span></th>
                    <th>Operation 10</th>
                    <th>Operation 20</th>
                    <th>Operation 30</th>
                    <th>Operation 40</th>
                    <th>Operation 50</th>
                    <th class="sortable-header" onclick="sortTable('progress')">Progress <span class="sort-indicator"></span></th>
                    <th class="sortable-header" onclick="sortTable('priority')">Priority <span class="sort-indicator"></span></th>
                    <th>Pre-Flight Notes</th>
                    <th>Pre-Cert Notes</th>
                    <th>NCMR Notes</th>
                    <th class="sortable-header" onclick="sortTable('delivery')">Delivery Date <span class="sort-indicator"></span></th>
                    <th class="sortable-header" onclick="sortTable('team')">Team <span class="sort-indicator"></span></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="aircraft-tbody">
                <tr draggable="true">
                    <td><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" class="row-checkbox" /></td>
                    <td><input type="text" class="table-input" placeholder="AC-001" value="AC-001" /></td>
                    <td>
                        <select class="table-input">
                            <option value="">Select Model</option>
                            <option value="PA-28-181" selected>PA-28-181</option>
                            <option value="PA-28-181 DX">PA-28-181 DX</option>
                            <option value="PA-44-180">PA-44-180</option>
                            <option value="PA-46-350P">PA-46-350P</option>
                            <option value="PA-46-500">PA-46-500</option>
                            <option value="PA-46-700">PA-46-700</option>
                        </select>
                    </td>
                    <td>
                        <select class="status-select production-ready">
                            <option value="Production Ready" selected>Production Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Quality Check">Quality Check</option>
                        </select>
                    </td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 60%;">
                                <div class="progress-text">60%</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <select class="priority-select medium">
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </td>
                    <td><textarea class="notes-input" placeholder="Enter pre-flight notes...">Electrical systems checked</textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter pre-cert notes...">Ready for certification</textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter NCMR notes..."></textarea></td>
                    <td><input type="date" class="table-input" value="2025-01-15" /></td>
                    <td><input type="text" class="table-input" placeholder="Team Name" value="Alpha Team" /></td>
                    <td>
                        <button class="btn-small btn-danger" onclick="deleteAircraft(this)" title="Delete Aircraft">üóëÔ∏è</button>
                        <button class="btn-small" onclick="duplicateAircraft(this)" title="Duplicate Aircraft">üìã</button>
                    </td>
                </tr>
                <tr draggable="true">
                    <td><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" class="row-checkbox" /></td>
                    <td><input type="text" class="table-input" placeholder="AC-002" value="AC-002" /></td>
                    <td>
                        <select class="table-input">
                            <option value="">Select Model</option>
                            <option value="PA-28-181">PA-28-181</option>
                            <option value="PA-28-181 DX">PA-28-181 DX</option>
                            <option value="PA-44-180" selected>PA-44-180</option>
                            <option value="PA-46-350P">PA-46-350P</option>
                            <option value="PA-46-500">PA-46-500</option>
                            <option value="PA-46-700">PA-46-700</option>
                        </select>
                    </td>
                    <td>
                        <select class="status-select in-progress">
                            <option value="Production Ready">Production Ready</option>
                            <option value="In Progress" selected>In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Quality Check">Quality Check</option>
                        </select>
                    </td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 40%;">
                                <div class="progress-text">40%</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <select class="priority-select high">
                            <option value="Critical">Critical</option>
                            <option value="High" selected>High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </td>
                    <td><textarea class="notes-input" placeholder="Enter pre-flight notes...">Wing assembly in progress</textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter pre-cert notes..."></textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter NCMR notes..."></textarea></td>
                    <td><input type="date" class="table-input" value="2025-01-20" /></td>
                    <td><input type="text" class="table-input" placeholder="Team Name" value="Beta Team" /></td>
                    <td>
                        <button class="btn-small btn-danger" onclick="deleteAircraft(this)" title="Delete Aircraft">üóëÔ∏è</button>
                        <button class="btn-small" onclick="duplicateAircraft(this)" title="Duplicate Aircraft">üìã</button>
                    </td>
                </tr>
                <tr draggable="true">
                    <td><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" class="row-checkbox" /></td>
                    <td><input type="text" class="table-input" placeholder="AC-003" value="AC-003" /></td>
                    <td>
                        <select class="table-input">
                            <option value="">Select Model</option>
                            <option value="PA-28-181">PA-28-181</option>
                            <option value="PA-28-181 DX">PA-28-181 DX</option>
                            <option value="PA-44-180">PA-44-180</option>
                            <option value="PA-46-350P" selected>PA-46-350P</option>
                            <option value="PA-46-500">PA-46-500</option>
                            <option value="PA-46-700">PA-46-700</option>
                        </select>
                    </td>
                    <td>
                        <select class="status-select quality-check">
                            <option value="Production Ready">Production Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Quality Check" selected>Quality Check</option>
                        </select>
                    </td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td class="operation-cell"><input type="checkbox" class="operation-checkbox" checked /></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%;">
                                <div class="progress-text">100%</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <select class="priority-select critical">
                            <option value="Critical" selected>Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </td>
                    <td><textarea class="notes-input" placeholder="Enter pre-flight notes...">Final quality inspection required</textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter pre-cert notes...">Certification pending</textarea></td>
                    <td><textarea class="notes-input" placeholder="Enter NCMR notes...">Minor adjustments needed</textarea></td>
                    <td><input type="date" class="table-input" value="2025-01-10" /></td>
                    <td><input type="text" class="table-input" placeholder="Team Name" value="QA Team" /></td>
                    <td>
                        <button class="btn-small btn-danger" onclick="deleteAircraft(this)" title="Delete Aircraft">üóëÔ∏è</button>
                        <button class="btn-small" onclick="duplicateAircraft(this)" title="Duplicate Aircraft">üìã</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="last-updated" id="last-updated">
        Dashboard Last Updated: Loading...
    </div>

    <!-- Security Notification -->
    <div id="security-notification" class="security-notification">
        <span id="security-message">üîí Data encrypted & saved securely</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // ====================================================================
        // SECURITY CORE FUNCTIONS (DEFINED FIRST)
        // ====================================================================
        
        // Global security variables
        let sessionDuration = 30 * 60; // 30 minutes in seconds
        let sessionTimer = sessionDuration;
        let sessionInterval = null;
        let lastActivity = Date.now();
        
        // Rate limiting variables
        let actionCount = 0;
        let actionResetTimer = null;
        
        // Idle detection variables
        let idleTimer = 0;
        let idleInterval = null;
        let isScreenLocked = false;
        
        // Initialize security logging
        function initializeSecurityLog() {
            if (!localStorage.getItem('securityAuditLog')) {
                localStorage.setItem('securityAuditLog', JSON.stringify([]));
            }
        }
        
        // Security event logging
        function logSecurityEvent(action, details = {}) {
            try {
                const log = JSON.parse(localStorage.getItem('securityAuditLog') || '[]');
                const event = {
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details,
                    userAgent: navigator.userAgent.substring(0, 100),
                    url: window.location.href
                };
                
                log.push(event);
                
                // Keep only last 500 events
                if (log.length > 500) {
                    log.splice(0, log.length - 500);
                }
                
                localStorage.setItem('securityAuditLog', JSON.stringify(log));
                console.log('Security event logged:', action);
            } catch (error) {
                console.warn('Failed to log security event:', error);
            }
        }
        
        // Input sanitization
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            
            // Remove potentially dangerous characters and patterns
            return input
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<[^>]*>/g, '')
                .replace(/javascript:/gi, '')
                .replace(/vbscript:/gi, '')
                .replace(/onload=/gi, '')
                .replace(/onerror=/gi, '')
                .replace(/onclick=/gi, '')
                .substring(0, 1000); // Limit length
        }
        
        // Enhanced input validation
        function validateInput(input, type = 'text') {
            const sanitized = sanitizeInput(input);
            
            switch (type) {
                case 'aircraftId':
                    // Aircraft ID should match pattern like AC-001, ABC-1234, etc.
                    const aircraftPattern = /^[A-Z]{1,3}-\d{1,4}$/;
                    return aircraftPattern.test(sanitized) ? sanitized : '';
                case 'email':
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailPattern.test(sanitized) ? sanitized : '';
                case 'date':
                    const date = new Date(sanitized);
                    return !isNaN(date.getTime()) ? sanitized : '';
                default:
                    return sanitized;
            }
        }
        
        // Data encryption for localStorage
        function encryptData(data) {
            try {
                const jsonString = JSON.stringify(data);
                // Simple but reliable encryption
                const encoded = btoa(unescape(encodeURIComponent(jsonString)));
                
                // XOR cipher with rotating key
                const key = 'SecureAircraft2025';
                let encrypted = '';
                for (let i = 0; i < encoded.length; i++) {
                    const charCode = encoded.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    encrypted += String.fromCharCode(charCode);
                }
                
                // Base64 encode the result to ensure safe storage
                return btoa(encrypted);
            } catch (error) {
                console.warn('Encryption failed:', error);
                return JSON.stringify(data);
            }
        }
        
        function decryptData(encryptedData) {
            try {
                // Try new encryption format first
                const decoded = atob(encryptedData);
                
                // XOR decrypt with rotating key
                const key = 'SecureAircraft2025';
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    decrypted += String.fromCharCode(charCode);
                }
                
                const finalDecoded = decodeURIComponent(escape(atob(decrypted)));
                return JSON.parse(finalDecoded);
            } catch (error) {
                console.log('Trying fallback decryption for legacy data...');
                try {
                    // Fallback for old unencrypted data
                    return JSON.parse(encryptedData);
                } catch (fallbackError) {
                    try {
                        // Try simple base64 decode for older encrypted data
                        const decoded = decodeURIComponent(escape(atob(encryptedData)));
                        return JSON.parse(decoded);
                    } catch (finalError) {
                        console.warn('All decryption methods failed');
                        return null;
                    }
                }
            }
        }
        
        // Session management
        function resetSessionTimeout() {
            lastActivity = Date.now();
            sessionTimer = sessionDuration;
            
            // Reset idle timer when user is active
            resetIdleTimer();
            
            if (sessionInterval) {
                clearInterval(sessionInterval);
            }
            
            sessionInterval = setInterval(updateSessionTimer, 1000);
            logSecurityEvent('SESSION_ACTIVITY', { timestamp: new Date().toISOString() });
        }
        
        // Action rate limiting
        function rateLimitCheck(action = 'GENERIC') {
            actionCount++;
            
            // Reset counter every 10 seconds
            if (actionResetTimer) clearTimeout(actionResetTimer);
            actionResetTimer = setTimeout(() => { actionCount = 0; }, 10000);
            
            if (actionCount > 20) { // Max 20 actions per 10 seconds
                logSecurityEvent('RATE_LIMIT_EXCEEDED', { 
                    action: action,
                    count: actionCount,
                    timestamp: new Date().toISOString()
                });
                showSecurityNotification('üõ°Ô∏è Too many actions. Please slow down.', true);
                return false;
            }
            return true;
        }
        
        // Idle detection and screen lock
        function resetIdleTimer() {
            idleTimer = 0;
            
            // Unlock screen if it was locked
            if (isScreenLocked) {
                unlockScreen();
            }
            
            // Start/restart idle monitoring
            if (idleInterval) clearInterval(idleInterval);
            idleInterval = setInterval(() => {
                idleTimer++;
                
                // Lock screen after 5 minutes of inactivity
                if (idleTimer >= 300 && !isScreenLocked) {
                    lockScreen();
                }
            }, 1000);
        }
        
        function lockScreen() {
            isScreenLocked = true;
            document.body.style.filter = 'blur(10px)';
            document.body.style.pointerEvents = 'none';
            
            logSecurityEvent('SCREEN_LOCKED', { 
                idleTime: idleTimer,
                timestamp: new Date().toISOString()
            });
            
            showSecurityNotification('üîí Screen locked due to inactivity. Click to unlock.', true);
            
            // Add click to unlock
            document.addEventListener('click', unlockScreen, { once: true });
            document.addEventListener('keydown', unlockScreen, { once: true });
        }
        
        function unlockScreen() {
            if (!isScreenLocked) return;
            
            isScreenLocked = false;
            document.body.style.filter = '';
            document.body.style.pointerEvents = '';
            
            logSecurityEvent('SCREEN_UNLOCKED', {
                timestamp: new Date().toISOString()
            });
            
            showSecurityNotification('üîì Screen unlocked');
            resetIdleTimer();
        }
        
        function updateSessionTimer() {
            sessionTimer--;
            
            const minutes = Math.floor(sessionTimer / 60);
            const seconds = sessionTimer % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('session-timer');
            if (timerElement) {
                timerElement.textContent = timeString;
                
                // Color code based on time remaining
                if (sessionTimer <= 300) { // 5 minutes
                    timerElement.className = 'session-timer session-warning';
                } else if (sessionTimer <= 600) { // 10 minutes
                    timerElement.className = 'session-timer';
                } else {
                    timerElement.className = 'session-timer';
                }
            }
            
            if (sessionTimer <= 0) {
                handleSessionExpiry();
            }
        }
        
        function handleSessionExpiry() {
            clearInterval(sessionInterval);
            logSecurityEvent('SESSION_EXPIRED', {});
            
            if (confirm('üõ°Ô∏è Session expired for security. Save your work and refresh the page to continue.')) {
                saveDataToStorage();
            }
            
            // Disable all inputs
            document.querySelectorAll('input, select, textarea, button').forEach(el => {
                el.disabled = true;
            });
        }
        
        // Security notifications
        function showSecurityNotification(message, isWarning = false) {
            const notification = document.getElementById('security-notification');
            const messageElement = document.getElementById('security-message');
            
            if (notification && messageElement) {
                messageElement.textContent = message;
                
                if (isWarning) {
                    notification.classList.add('security-warning');
                } else {
                    notification.classList.remove('security-warning');
                }
                
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }
        
        // ====================================================================
        // MAIN DASHBOARD FUNCTIONALITY
        // ====================================================================
        
        let currentContextRow = null;
        let draggedRow = null;
        let lastDeletedData = null;
        let sortDirection = {};
        let quickFilters = {
            status: null,
            priority: null,
            date: null
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSecurityLog();
            initializeDashboard();
            setupEventListeners();
            loadDataFromStorage();
            updateSummaryCards();
            updateQuickFilterCounts();
            applyVisualIndicators();
            resetSessionTimeout();
            
            logSecurityEvent('DASHBOARD_LOADED', {
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            });
            
            // Auto-save every 30 seconds
            setInterval(saveDataToStorage, 30000);
            
            // Save when leaving page
            window.addEventListener('beforeunload', saveDataToStorage);
            
            // Setup security event listeners
            setupSecurityEventListeners();
        });

        function initializeDashboard() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                addEventListenersToRow(row);
                setupDragAndDrop(row);
                updateProgress(row);
                applyRowVisualIndicators(row);
            });
        }
        
        function setupSecurityEventListeners() {
            // Activity tracking for session timeout and idle detection
            document.addEventListener('click', () => {
                if (rateLimitCheck('CLICK')) {
                    resetSessionTimeout();
                }
            });
            
            document.addEventListener('keypress', () => {
                if (rateLimitCheck('KEYPRESS')) {
                    resetSessionTimeout();
                }
            });
            
            document.addEventListener('mousemove', function() {
                if (Date.now() - lastActivity > 60000) { // Only reset every minute
                    resetSessionTimeout();
                }
            });
            
            // Tab visibility security monitoring
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    logSecurityEvent('TAB_HIDDEN', {
                        timestamp: new Date().toISOString(),
                        timeHidden: new Date().toISOString()
                    });
                } else {
                    logSecurityEvent('TAB_VISIBLE', {
                        timestamp: new Date().toISOString(),
                        timeReturned: new Date().toISOString()
                    });
                    // Reset session when user returns to tab
                    resetSessionTimeout();
                }
            });
            
            // Copy protection
            document.addEventListener('copy', function(e) {
                const selection = window.getSelection().toString();
                if (selection.length > 50) {
                    if (!rateLimitCheck('COPY')) return;
                    
                    logSecurityEvent('DATA_COPY_ATTEMPT', { 
                        length: selection.length,
                        target: e.target.className 
                    });
                    
                    if (!e.target.closest('.notes-input, .table-input')) {
                        if (!confirm('‚ö†Ô∏è You are copying sensitive data. Continue?')) {
                            e.preventDefault();
                            showSecurityNotification('üõ°Ô∏è Data copying restricted for security', true);
                            return;
                        }
                    }
                }
            });
            
            // Print protection
            window.addEventListener('beforeprint', function(e) {
                if (!rateLimitCheck('PRINT')) {
                    e.preventDefault();
                    return;
                }
                
                logSecurityEvent('PRINT_ATTEMPT', {});
                
                if (!confirm('‚ö†Ô∏è You are about to print sensitive aircraft data. Continue?')) {
                    e.preventDefault();
                    showSecurityNotification('üõ°Ô∏è Print operation cancelled for security', true);
                }
            });
            
            // Screenshot detection
            document.addEventListener('keydown', function(e) {
                if (e.key === 'PrintScreen' || 
                    (e.metaKey && e.shiftKey && e.key === '4') || // Mac screenshot
                    (e.ctrlKey && e.shiftKey && e.key === 'S')) { // Some screenshot tools
                    
                    if (rateLimitCheck('SCREENSHOT')) {
                        logSecurityEvent('SCREENSHOT_ATTEMPT', { key: e.key });
                        showSecurityNotification('‚ö†Ô∏è Screenshot detected. Activity logged.', true);
                    }
                }
            });
            
            // Input validation
            document.addEventListener('input', function(e) {
                if (e.target.type === 'text' || e.target.tagName === 'TEXTAREA') {
                    if (rateLimitCheck('INPUT')) {
                        validateAndSanitizeInput(e.target);
                    }
                }
            });
            
            // Initialize idle monitoring
            resetIdleTimer();
        }
        
        function validateAndSanitizeInput(inputElement) {
            const originalValue = inputElement.value;
            let sanitizedValue = sanitizeInput(originalValue);
            
            // Length validation
            if (sanitizedValue.length > 1000) {
                sanitizedValue = sanitizedValue.substring(0, 1000);
                showSecurityNotification('üõ°Ô∏è Input truncated for security', true);
            }
            
            // Aircraft ID validation
            if (inputElement.placeholder && inputElement.placeholder.includes('AC-')) {
                if (sanitizedValue && !validateInput(sanitizedValue, 'aircraftId') && sanitizedValue.length > 0) {
                    inputElement.classList.add('input-invalid');
                    setTimeout(() => inputElement.classList.remove('input-invalid'), 2000);
                }
            }
            
            // Update the input if it was changed
            if (originalValue !== sanitizedValue) {
                inputElement.value = sanitizedValue;
                logSecurityEvent('INPUT_SANITIZED', {
                    original: originalValue.substring(0, 50),
                    sanitized: sanitizedValue.substring(0, 50)
                });
            }
        }

        function setupEventListeners() {
            // Search and filter
            document.getElementById('search-input').addEventListener('input', searchAndFilter);
            document.getElementById('status-filter').addEventListener('change', searchAndFilter);
            document.getElementById('team-filter').addEventListener('input', searchAndFilter);
            document.getElementById('priority-filter').addEventListener('change', searchAndFilter);
            
            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
        }

        // Enhanced save function with encryption and rate limiting
        function saveDataToStorage() {
            if (!rateLimitCheck('SAVE')) return;
            
            try {
                const rows = document.querySelectorAll('tbody tr');
                const aircraftData = [];
                
                rows.forEach(row => {
                    const rowData = {
                        aircraftId: sanitizeInput(row.querySelectorAll('.table-input')[0]?.value || ''),
                        model: sanitizeInput(row.querySelectorAll('.table-input')[1]?.value || ''),
                        status: row.querySelector('.status-select')?.value || 'In Progress',
                        operations: Array.from(row.querySelectorAll('.operation-checkbox')).map(cb => cb.checked),
                        priority: row.querySelector('.priority-select')?.value || 'Medium',
                        preFlightNotes: sanitizeInput(row.querySelectorAll('.notes-input')[0]?.value || ''),
                        preCertNotes: sanitizeInput(row.querySelectorAll('.notes-input')[1]?.value || ''),
                        ncmrNotes: sanitizeInput(row.querySelectorAll('.notes-input')[2]?.value || ''),
                        deliveryDate: row.querySelector('input[type="date"]')?.value || '',
                        team: sanitizeInput(row.querySelectorAll('.table-input')[4]?.value || '')
                    };
                    aircraftData.push(rowData);
                });
                
                const dashboardData = {
                    aircraft: aircraftData,
                    lastSaved: new Date().toISOString(),
                    version: '2.0',
                    securityHash: generateSecurityHash(aircraftData)
                };
                
                const encryptedData = encryptData(dashboardData);
                localStorage.setItem('aircraftDashboardData', encryptedData);
                
                updateLastSavedTime();
                showSecurityNotification('üîí Data encrypted & saved securely');
                
                logSecurityEvent('DATA_SAVED', {
                    aircraftCount: aircraftData.length,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('Failed to save data:', error);
                showSecurityNotification('‚ùå Save failed - check console for details', true);
                logSecurityEvent('SAVE_ERROR', { error: error.message });
            }
        }
        
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('aircraftDashboardData');
                if (!savedData) {
                    logSecurityEvent('NO_SAVED_DATA', {});
                    return false;
                }
                
                const dashboardData = decryptData(savedData);
                if (!dashboardData) {
                    logSecurityEvent('DECRYPT_FAILED', {});
                    return false;
                }
                
                // Verify data integrity
                if (dashboardData.securityHash) {
                    const currentHash = generateSecurityHash(dashboardData.aircraft);
                    if (currentHash !== dashboardData.securityHash) {
                        logSecurityEvent('DATA_INTEGRITY_VIOLATION', {});
                        if (!confirm('‚ö†Ô∏è Data integrity check failed. Data may have been tampered with. Continue loading?')) {
                            return false;
                        }
                    }
                }
                
                const tbody = document.getElementById('aircraft-tbody');
                tbody.innerHTML = '';
                
                dashboardData.aircraft.forEach(aircraftData => {
                    const newRow = createAircraftRow(aircraftData);
                    tbody.appendChild(newRow);
                    addEventListenersToRow(newRow);
                    setupDragAndDrop(newRow);
                });
                
                updateSummaryCards();
                updateLastSavedTime(dashboardData.lastSaved);
                
                logSecurityEvent('DATA_LOADED', {
                    aircraftCount: dashboardData.aircraft.length,
                    version: dashboardData.version
                });
                
                return true;
            } catch (error) {
                console.error('Failed to load data:', error);
                logSecurityEvent('LOAD_ERROR', { error: error.message });
                return false;
            }
        }
        
        function generateSecurityHash(data) {
            // Simple hash for data integrity (use proper crypto in production)
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString(16);
        }
        
        // Security log viewer
        function viewSecurityLog() {
            try {
                const log = JSON.parse(localStorage.getItem('securityAuditLog') || '[]');
                
                if (log.length === 0) {
                    alert('No security events logged yet.');
                    return;
                }
                
                const logWindow = window.open('', '_blank', 'width=800,height=600');
                logWindow.document.write(`
                    <html>
                    <head>
                        <title>Security Audit Log</title>
                        <style>
                            body { font-family: monospace; margin: 20px; background: #f8f9fa; }
                            h2 { color: #495057; }
                            .log-entry { 
                                margin: 10px 0; 
                                padding: 15px; 
                                border-left: 4px solid #007bff; 
                                background: white; 
                                border-radius: 4px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            .timestamp { font-weight: bold; color: #495057; }
                            .action { color: #007bff; font-weight: bold; margin: 5px 0; }
                            .details { color: #6c757d; font-size: 12px; }
                            .critical { border-left-color: #dc3545; }
                            .warning { border-left-color: #ffc107; }
                        </style>
                    </head>
                    <body>
                        <h2>üõ°Ô∏è Security Audit Log</h2>
                        <p><strong>Total Events:</strong> ${log.length}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                        <hr>
                        ${log.reverse().map(entry => {
                            const isCritical = entry.action.includes('VIOLATION') || entry.action.includes('FAILED');
                            const isWarning = entry.action.includes('ATTEMPT') || entry.action.includes('WARNING');
                            const cssClass = isCritical ? 'critical' : (isWarning ? 'warning' : '');
                            
                            return `
                                <div class="log-entry ${cssClass}">
                                    <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                                    <div class="action">${entry.action}</div>
                                    <div class="details">${JSON.stringify(entry.details, null, 2)}</div>
                                </div>
                            `;
                        }).join('')}
                    </body>
                    </html>
                `);
                
                logSecurityEvent('AUDIT_LOG_VIEWED', {});
                
            } catch (error) {
                console.error('Failed to view security log:', error);
                alert('Failed to load security log. Check console for details.');
            }
        }

        // Export functions
        function exportToCSV() {
            logSecurityEvent('CSV_EXPORT', {});
            
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tr');
            let csvContent = '';
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                
                cols.forEach((col, index) => {
                    if (index === 0) return; // Skip drag handle column
                    
                    let cellText = '';
                    const input = col.querySelector('input');
                    const select = col.querySelector('select');
                    const textarea = col.querySelector('textarea');
                    
                    if (input && input.type !== 'checkbox') {
                        cellText = input.value;
                    } else if (select) {
                        cellText = select.value;
                    } else if (textarea) {
                        cellText = textarea.value;
                    } else if (input && input.type === 'checkbox') {
                        cellText = input.checked ? 'Yes' : 'No';
                    } else {
                        cellText = col.textContent.trim();
                    }
                    
                    cellText = cellText.replace(/\s+/g, ' ');
                    if (cellText.includes(',') || cellText.includes('"')) {
                        cellText = '"' + cellText.replace(/"/g, '""') + '"';
                    }
                    rowData.push(cellText);
                });
                
                csvContent += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'aircraft_production_dashboard_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function copyTableData() {
            logSecurityEvent('TABLE_COPY', {});
            
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tr');
            let tableText = '';
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                
                cols.forEach((col, index) => {
                    if (index === 0) return; // Skip drag handle column
                    
                    let cellText = '';
                    const input = col.querySelector('input');
                    const select = col.querySelector('select');
                    const textarea = col.querySelector('textarea');
                    
                    if (input && input.type !== 'checkbox') {
                        cellText = input.value;
                    } else if (select) {
                        cellText = select.value;
                    } else if (textarea) {
                        cellText = textarea.value;
                    } else if (input && input.type === 'checkbox') {
                        cellText = input.checked ? 'Yes' : 'No';
                    } else {
                        cellText = col.textContent.trim();
                    }
                    
                    cellText = cellText.replace(/\s+/g, ' ');
                    rowData.push(cellText);
                });
                
                tableText += rowData.join('\t') + '\n';
            });
            
            navigator.clipboard.writeText(tableText).then(() => {
                showSecurityNotification('‚úÖ Table data copied to clipboard!');
            }).catch(() => {
                showSecurityNotification('‚ùå Copy failed. Please try the CSV export instead.', true);
            });
        }

        // PDF Report Generation
        function generatePDFReport() {
            logSecurityEvent('PDF_EXPORT', {});
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date for report
            const reportDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate metrics for summary
            const aircraftData = gatherAircraftData();
            const metrics = calculateReportMetrics(aircraftData);
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(30, 60, 114);
            doc.text('Aircraft Production Report', 20, 25);
            
            doc.setFontSize(12);
            doc.setTextColor(102, 117, 127);
            doc.text(`Generated on ${reportDate}`, 20, 35);
            
            // Executive Summary
            let yPosition = 50;
            doc.setFontSize(16);
            doc.setTextColor(73, 80, 87);
            doc.text('Executive Summary', 20, yPosition);
            
            yPosition += 15;
            doc.setFontSize(11);
            doc.setTextColor(33, 37, 41);
            
            const summaryText = [
                `Total Aircraft in Production: ${metrics.totalAircraft}`,
                `Completed Aircraft: ${metrics.completedAircraft} (${metrics.completionRate}%)`,
                `Average Progress: ${metrics.avgProgress}%`,
                `Overdue Aircraft: ${metrics.overdueCount}`,
                `Critical Priority Items: ${metrics.criticalCount}`,
                `Most Active Team: ${metrics.mostActiveTeam}`
            ];
            
            summaryText.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 6;
            });
            
            // Status Breakdown
            yPosition += 10;
            doc.setFontSize(14);
            doc.setTextColor(73, 80, 87);
            doc.text('Status Breakdown', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            const statusData = [
                ['Status', 'Count', 'Percentage'],
                ['Production Ready', metrics.statusCounts['Production Ready'].toString(), `${((metrics.statusCounts['Production Ready'] / metrics.totalAircraft) * 100).toFixed(1)}%`],
                ['In Progress', metrics.statusCounts['In Progress'].toString(), `${((metrics.statusCounts['In Progress'] / metrics.totalAircraft) * 100).toFixed(1)}%`],
                ['On Hold', metrics.statusCounts['On Hold'].toString(), `${((metrics.statusCounts['On Hold'] / metrics.totalAircraft) * 100).toFixed(1)}%`],
                ['Quality Check', metrics.statusCounts['Quality Check'].toString(), `${((metrics.statusCounts['Quality Check'] / metrics.totalAircraft) * 100).toFixed(1)}%`]
            ];
            
            doc.autoTable({
                head: [statusData[0]],
                body: statusData.slice(1),
                startY: yPosition,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [30, 60, 114] },
                margin: { left: 20, right: 20 }
            });
            
            // New page for detailed aircraft information
            doc.addPage();
            yPosition = 25;
            
            doc.setFontSize(16);
            doc.setTextColor(73, 80, 87);
            doc.text('Aircraft Details & Operations Summary', 20, yPosition);
            
            yPosition += 15;
            
            // Create detailed table
            const tableData = [];
            aircraftData.forEach(aircraft => {
                const completedOps = aircraft.operations.filter(op => op).length;
                const totalOps = aircraft.operations.length;
                const progress = totalOps > 0 ? Math.round((completedOps / totalOps) * 100) : 0;
                
                const deliveryStatus = aircraft.deliveryDate ? 
                    (new Date(aircraft.deliveryDate) < new Date() && progress < 100 ? 'OVERDUE' : 'On Track') : 
                    'No Date Set';
                
                tableData.push([
                    aircraft.aircraftId || 'Unassigned',
                    aircraft.model || 'Not Selected',
                    aircraft.status || 'Unknown',
                    `${completedOps}/${totalOps}`,
                    `${progress}%`,
                    aircraft.priority || 'Medium',
                    aircraft.deliveryDate || 'TBD',
                    deliveryStatus,
                    aircraft.team || 'Unassigned'
                ]);
            });
            
            doc.autoTable({
                head: [['Aircraft ID', 'Model', 'Status', 'Operations', 'Progress', 'Priority', 'Delivery', 'Timeline', 'Team']],
                body: tableData,
                startY: yPosition,
                theme: 'striped',
                styles: { 
                    fontSize: 8,
                    cellPadding: 3
                },
                headStyles: { 
                    fillColor: [30, 60, 114],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    4: { halign: 'center' },
                    7: { halign: 'center' }
                },
                didParseCell: function(data) {
                    if (data.cell.text[0] === 'OVERDUE') {
                        data.cell.styles.textColor = [220, 53, 69];
                        data.cell.styles.fontStyle = 'bold';
                    }
                    if (data.column.index === 5) {
                        if (data.cell.text[0] === 'Critical') {
                            data.cell.styles.fillColor = [248, 215, 218];
                            data.cell.styles.textColor = [114, 28, 36];
                        } else if (data.cell.text[0] === 'High') {
                            data.cell.styles.fillColor = [255, 243, 205];
                            data.cell.styles.textColor = [133, 100, 4];
                        }
                    }
                }
            });
            
            // Footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(102, 117, 127);
                doc.text(`Aircraft Production Dashboard - Page ${i} of ${pageCount}`, 20, 285);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 150, 285);
            }
            
            // Save the PDF
            const fileName = `Aircraft_Production_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function gatherAircraftData() {
            const rows = document.querySelectorAll('tbody tr:not(.hidden-row)');
            const aircraftData = [];
            
            rows.forEach(row => {
                const rowData = {
                    aircraftId: row.querySelectorAll('.table-input')[0]?.value || '',
                    model: row.querySelectorAll('.table-input')[1]?.value || '',
                    status: row.querySelector('.status-select')?.value || '',
                    operations: Array.from(row.querySelectorAll('.operation-checkbox')).map(cb => cb.checked),
                    priority: row.querySelector('.priority-select')?.value || '',
                    preFlightNotes: row.querySelectorAll('.notes-input')[0]?.value || '',
                    preCertNotes: row.querySelectorAll('.notes-input')[1]?.value || '',
                    ncmrNotes: row.querySelectorAll('.notes-input')[2]?.value || '',
                    deliveryDate: row.querySelector('input[type="date"]')?.value || '',
                    team: row.querySelectorAll('.table-input')[4]?.value || ''
                };
                aircraftData.push(rowData);
            });
            
            return aircraftData;
        }

        function calculateReportMetrics(aircraftData) {
            const metrics = {
                totalAircraft: aircraftData.length,
                completedAircraft: 0,
                avgProgress: 0,
                overdueCount: 0,
                criticalCount: 0,
                mostActiveTeam: 'None',
                statusCounts: {
                    'Production Ready': 0,
                    'In Progress': 0,
                    'On Hold': 0,
                    'Quality Check': 0
                }
            };
            
            let totalProgress = 0;
            const teamCounts = {};
            
            aircraftData.forEach(aircraft => {
                const completedOps = aircraft.operations.filter(op => op).length;
                const totalOps = aircraft.operations.length;
                const progress = totalOps > 0 ? (completedOps / totalOps) : 0;
                totalProgress += progress;
                
                if (progress === 1) metrics.completedAircraft++;
                
                if (aircraft.deliveryDate) {
                    const deliveryDate = new Date(aircraft.deliveryDate);
                    const today = new Date();
                    if (deliveryDate < today && progress < 1) {
                        metrics.overdueCount++;
                    }
                }
                
                if (aircraft.priority === 'Critical') {
                    metrics.criticalCount++;
                }
                
                if (metrics.statusCounts.hasOwnProperty(aircraft.status)) {
                    metrics.statusCounts[aircraft.status]++;
                }
                
                const team = aircraft.team || 'Unassigned';
                teamCounts[team] = (teamCounts[team] || 0) + 1;
            });
            
            metrics.avgProgress = aircraftData.length > 0 ? 
                Math.round((totalProgress / aircraftData.length) * 100) : 0;
            metrics.completionRate = aircraftData.length > 0 ? 
                Math.round((metrics.completedAircraft / aircraftData.length) * 100) : 0;
            
            let maxCount = 0;
            for (const [team, count] of Object.entries(teamCounts)) {
                if (count > maxCount && team !== 'Unassigned') {
                    maxCount = count;
                    metrics.mostActiveTeam = team;
                }
            }
            
            return metrics;
        }

        // Selection functions
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
            });
            
            updateBulkControls();
        }

        function toggleRowSelection(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.add('selected-row');
            } else {
                row.classList.remove('selected-row');
            }
            
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all');
            
            if (checkedBoxes.length === rowCheckboxes.length) {
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.checked = false;
            }
            
            updateBulkControls();
        }

        function updateBulkControls() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const bulkButtons = document.querySelectorAll('.btn-purple');
            const selectedCount = document.getElementById('selected-count');
            
            selectedCount.textContent = selectedRows.length;
            
            if (selectedRows.length > 0) {
                bulkButtons.forEach(btn => btn.disabled = false);
            } else {
                bulkButtons.forEach(btn => btn.disabled = true);
            }
        }

        // Bulk operations
        function bulkUpdateStatus() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const newStatus = prompt('Enter new status:\n- Production Ready\n- In Progress\n- On Hold\n- Quality Check');
            
            if (newStatus && ['Production Ready', 'In Progress', 'On Hold', 'Quality Check'].includes(newStatus)) {
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const statusSelect = row.querySelector('.status-select');
                    statusSelect.value = newStatus;
                    updateStatusStyle(statusSelect);
                });
                
                updateSummaryCards();
                saveDataToStorage();
                logSecurityEvent('BULK_STATUS_UPDATE', { count: selectedRows.length, newStatus });
                showSecurityNotification(`Updated ${selectedRows.length} aircraft to "${newStatus}"`);
            }
        }

        function bulkUpdatePriority() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const newPriority = prompt('Enter new priority:\n- Critical\n- High\n- Medium\n- Low');
            
            if (newPriority && ['Critical', 'High', 'Medium', 'Low'].includes(newPriority)) {
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const prioritySelect = row.querySelector('.priority-select');
                    prioritySelect.value = newPriority;
                    updatePriorityStyle(prioritySelect);
                });
                
                saveDataToStorage();
                logSecurityEvent('BULK_PRIORITY_UPDATE', { count: selectedRows.length, newPriority });
                showSecurityNotification(`Updated ${selectedRows.length} aircraft to "${newPriority}" priority`);
            }
        }

        function bulkUpdateTeam() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const newTeam = prompt('Enter team name:');
            
            if (newTeam) {
                const sanitizedTeam = sanitizeInput(newTeam);
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const teamInput = row.querySelectorAll('.table-input')[4];
                    teamInput.value = sanitizedTeam;
                });
                
                saveDataToStorage();
                logSecurityEvent('BULK_TEAM_UPDATE', { count: selectedRows.length, newTeam: sanitizedTeam });
                showSecurityNotification(`Assigned ${selectedRows.length} aircraft to team "${sanitizedTeam}"`);
            }
        }

        function copySelectedAircraft() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            if (selectedRows.length === 0) return;
            
            const tbody = document.getElementById('aircraft-tbody');
            
            selectedRows.forEach(checkbox => {
                const originalRow = checkbox.closest('tr');
                const newRow = originalRow.cloneNode(true);
                
                // Clear aircraft ID
                const aircraftInput = newRow.querySelectorAll('.table-input')[0];
                aircraftInput.value = '';
                aircraftInput.placeholder = getNextAircraftId() + ' (Copy)';
                
                // Uncheck all checkboxes
                const checkboxes = newRow.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                
                // Reset progress
                const progressFill = newRow.querySelector('.progress-fill');
                progressFill.style.width = '0%';
                
                // Clear date
                const dateInput = newRow.querySelector('input[type="date"]');
                dateInput.value = '';
                
                newRow.classList.remove('selected-row');
                tbody.appendChild(newRow);
                addEventListenersToRow(newRow);
                setupDragAndDrop(newRow);
            });
            
            updateSummaryCards();
            saveDataToStorage();
            logSecurityEvent('BULK_COPY', { count: selectedRows.length });
            showSecurityNotification(`Copied ${selectedRows.length} aircraft`);
        }

        // Style update functions
        function updateStatusStyle(selectElement) {
            if (!selectElement) return;
            
            selectElement.classList.remove('production-ready', 'in-progress', 'on-hold', 'quality-check');
            
            const value = selectElement.value;
            if (value === 'Production Ready') {
                selectElement.classList.add('production-ready');
            } else if (value === 'In Progress') {
                selectElement.classList.add('in-progress');
            } else if (value === 'On Hold') {
                selectElement.classList.add('on-hold');
            } else if (value === 'Quality Check') {
                selectElement.classList.add('quality-check');
            }
        }

        function updatePriorityStyle(selectElement) {
            if (!selectElement) return;
            
            selectElement.classList.remove('critical', 'high', 'medium', 'low');
            const value = selectElement.value.toLowerCase();
            selectElement.classList.add(value);
        }

        // Summary cards update
        function updateSummaryCards() {
            const statusCells = document.querySelectorAll('tbody tr:not(.hidden-row) .status-select');
            const counts = {
                'Production Ready': 0,
                'In Progress': 0,
                'On Hold': 0,
                'Quality Check': 0
            };
            
            statusCells.forEach(select => {
                const status = select.value;
                if (counts.hasOwnProperty(status)) {
                    counts[status]++;
                }
            });
            
            document.getElementById('prod-ready-count').textContent = counts['Production Ready'];
            document.getElementById('in-progress-count').textContent = counts['In Progress'];
            document.getElementById('on-hold-count').textContent = counts['On Hold'];
            document.getElementById('quality-check-count').textContent = counts['Quality Check'];
            document.getElementById('total-count').textContent = statusCells.length;
            
            updateQuickFilterCounts();
        }

        function updateQuickFilterCounts() {
            const statusCells = document.querySelectorAll('tbody tr:not(.hidden-row) .status-select');
            const counts = {
                'Production Ready': 0,
                'In Progress': 0,
                'On Hold': 0,
                'Quality Check': 0
            };
            
            statusCells.forEach(select => {
                const status = select.value;
                if (counts.hasOwnProperty(status)) {
                    counts[status]++;
                }
            });
            
            // Update quick filter chip counts
            const quickProdReady = document.getElementById('quick-prod-ready');
            const quickInProgress = document.getElementById('quick-in-progress');
            const quickOnHold = document.getElementById('quick-on-hold');
            const quickQualityCheck = document.getElementById('quick-quality-check');
            
            if (quickProdReady) quickProdReady.textContent = counts['Production Ready'];
            if (quickInProgress) quickInProgress.textContent = counts['In Progress'];
            if (quickOnHold) quickOnHold.textContent = counts['On Hold'];
            if (quickQualityCheck) quickQualityCheck.textContent = counts['Quality Check'];
        }

        // Sortable columns functionality
        function sortTable(column) {
            const tbody = document.getElementById('aircraft-tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.hidden-row)'));
            
            // Toggle sort direction
            if (!sortDirection[column]) sortDirection[column] = 'asc';
            else sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            
            // Clear other sort indicators
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add current sort indicator
            const currentHeader = document.querySelector(`[onclick="sortTable('${column}')"]`);
            currentHeader.classList.add(sortDirection[column] === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'aircraft-id':
                        aVal = a.querySelectorAll('.table-input')[0].value;
                        bVal = b.querySelectorAll('.table-input')[0].value;
                        break;
                    case 'model':
                        aVal = a.querySelectorAll('.table-input')[1].value;
                        bVal = b.querySelectorAll('.table-input')[1].value;
                        break;
                    case 'status':
                        aVal = a.querySelector('.status-select').value;
                        bVal = b.querySelector('.status-select').value;
                        break;
                    case 'priority':
                        const priorities = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
                        aVal = priorities[a.querySelector('.priority-select').value] || 0;
                        bVal = priorities[b.querySelector('.priority-select').value] || 0;
                        break;
                    case 'progress':
                        aVal = getRowProgress(a);
                        bVal = getRowProgress(b);
                        break;
                    case 'delivery':
                        aVal = new Date(a.querySelector('input[type="date"]').value || '2099-12-31');
                        bVal = new Date(b.querySelector('input[type="date"]').value || '2099-12-31');
                        break;
                    case 'team':
                        aVal = a.querySelectorAll('.table-input')[4].value;
                        bVal = b.querySelectorAll('.table-input')[4].value;
                        break;
                }
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection[column] === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Reorder rows in DOM
            rows.forEach(row => tbody.appendChild(row));
            
            logSecurityEvent('TABLE_SORTED', { column, direction: sortDirection[column] });
        }

        // Quick filter functionality
        function toggleQuickFilter(type, value, chipElement) {
            // Clear other active chips of same type
            if (type === 'status') {
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes('Production Ready') || 
                        chip.textContent.includes('In Progress') || 
                        chip.textContent.includes('On Hold') || 
                        chip.textContent.includes('Quality Check')) {
                        chip.classList.remove('active');
                    }
                });
            } else if (type === 'priority') {
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes('Critical') || 
                        chip.textContent.includes('High Priority')) {
                        chip.classList.remove('active');
                    }
                });
            } else if (type === 'date') {
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes('Overdue') || 
                        chip.textContent.includes('Due This Week')) {
                        chip.classList.remove('active');
                    }
                });
            }
            
            // Toggle current chip
            const isActive = chipElement.classList.contains('active');
            chipElement.classList.toggle('active');
            
            // Update filter state
            if (isActive) {
                quickFilters[type] = null;
            } else {
                quickFilters[type] = value;
            }
            
            // Apply filters
            applyQuickFilters();
            
            logSecurityEvent('QUICK_FILTER', { type, value, isActive: !isActive });
        }

        function applyQuickFilters() {
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                let visible = true;
                
                // Status filter
                if (quickFilters.status) {
                    const status = row.querySelector('.status-select')?.value;
                    if (status !== quickFilters.status) visible = false;
                }
                
                // Priority filter
                if (quickFilters.priority) {
                    const priority = row.querySelector('.priority-select')?.value;
                    if (priority !== quickFilters.priority) visible = false;
                }
                
                // Date filter
                if (quickFilters.date) {
                    const deliveryInput = row.querySelector('input[type="date"]');
                    const deliveryDate = new Date(deliveryInput?.value);
                    const today = new Date();
                    const progress = getRowProgress(row);
                    
                    if (quickFilters.date === 'overdue') {
                        if (!(deliveryDate < today && progress < 100)) visible = false;
                    } else if (quickFilters.date === 'thisweek') {
                        const weekFromNow = new Date();
                        weekFromNow.setDate(today.getDate() + 7);
                        if (!(deliveryDate >= today && deliveryDate <= weekFromNow)) visible = false;
                    }
                }
                
                // Apply visibility
                if (visible) {
                    row.classList.remove('hidden-row');
                } else {
                    row.classList.add('hidden-row');
                }
            });
            
            updateSummaryCards();
        }

        // Search and filter
        function searchAndFilter() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const teamFilter = document.getElementById('team-filter').value.toLowerCase();
            const priorityFilter = document.getElementById('priority-filter').value;
            
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const aircraftInput = row.querySelectorAll('.table-input')[0];
                const modelSelect = row.querySelectorAll('.table-input')[1];
                const statusSelect = row.querySelector('.status-select');
                const prioritySelect = row.querySelector('.priority-select');
                const teamInput = row.querySelectorAll('.table-input')[4];
                
                if (!aircraftInput || !modelSelect || !statusSelect || !prioritySelect || !teamInput) return;
                
                const aircraftValue = aircraftInput.value.toLowerCase();
                const modelValue = modelSelect.value.toLowerCase();
                const statusValue = statusSelect.value;
                const priorityValue = prioritySelect.value;
                const teamValue = teamInput.value.toLowerCase();
                
                const matchesSearch = aircraftValue.includes(searchTerm) || modelValue.includes(searchTerm);
                const matchesStatus = !statusFilter || statusValue === statusFilter;
                const matchesTeam = !teamFilter || teamValue.includes(teamFilter);
                const matchesPriority = !priorityFilter || priorityValue === priorityFilter;
                
                if (matchesSearch && matchesStatus && matchesTeam && matchesPriority) {
                    row.classList.remove('hidden-row');
                } else {
                    row.classList.add('hidden-row');
                }
            });
            
            updateSummaryCards();
            logSecurityEvent('SEARCH_FILTER', { searchTerm, statusFilter, teamFilter, priorityFilter });
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('team-filter').value = '';
            document.getElementById('priority-filter').value = '';
            
            // Clear quick filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            quickFilters = { status: null, priority: null, date: null };
            
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.classList.remove('hidden-row');
            });
            
            updateSummaryCards();
            logSecurityEvent('FILTERS_CLEARED', {});
        }

        // Individual aircraft actions
        function deleteAircraft(button) {
            const row = button.closest('tr');
            const aircraftInput = row.querySelectorAll('.table-input')[0];
            const aircraftId = aircraftInput.value || 'this aircraft';
            
            if (confirm(`Are you sure you want to delete ${aircraftId}?`)) {
                logSecurityEvent('AIRCRAFT_DELETED', { aircraftId });
                
                row.remove();
                updateSummaryCards();
                updateBulkControls();
                saveDataToStorage();
                
                showSecurityNotification(`üóëÔ∏è Deleted ${aircraftId}`);
            }
        }

        function duplicateAircraft(button) {
            const originalRow = button.closest('tr');
            const tbody = document.getElementById('aircraft-tbody');
            const newRow = originalRow.cloneNode(true);
            
            // Clear the aircraft ID and mark as copy
            const aircraftInput = newRow.querySelectorAll('.table-input')[0];
            const originalId = aircraftInput.value;
            aircraftInput.value = '';
            aircraftInput.placeholder = getNextAircraftId() + ' (Copy)';
            
            // Uncheck all checkboxes
            const checkboxes = newRow.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Reset progress
            const progressFill = newRow.querySelector('.progress-fill');
            const progressText = newRow.querySelector('.progress-text');
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            
            // Clear date
            const dateInput = newRow.querySelector('input[type="date"]');
            dateInput.value = '';
            
            newRow.classList.remove('selected-row');
            tbody.appendChild(newRow);
            addEventListenersToRow(newRow);
            setupDragAndDrop(newRow);
            
            updateSummaryCards();
            saveDataToStorage();
            
            logSecurityEvent('AIRCRAFT_DUPLICATED', { originalId });
            showSecurityNotification(`üìã Duplicated aircraft ${originalId}`);
            
            newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add new aircraft with rate limiting
        function addNewAircraft() {
            if (!rateLimitCheck('ADD_AIRCRAFT')) return;
            
            const tbody = document.getElementById('aircraft-tbody');
            const newRow = document.createElement('tr');
            newRow.draggable = true;
            
            const nextId = getNextAircraftId();
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30); // 30 days from today
            const dateString = defaultDate.toISOString().split('T')[0];
            
            newRow.innerHTML = `
                <td><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" class="row-checkbox" /></td>
                <td><input type="text" class="table-input" placeholder="${nextId}" value="${nextId}" /></td>
                <td>
                    <select class="table-input">
                        <option value="">Select Model</option>
                        <option value="PA-28-181">PA-28-181</option>
                        <option value="PA-28-181 DX">PA-28-181 DX</option>
                        <option value="PA-44-180">PA-44-180</option>
                        <option value="PA-46-350P">PA-46-350P</option>
                        <option value="PA-46-500">PA-46-500</option>
                        <option value="PA-46-700">PA-46-700</option>
                    </select>
                </td>
                <td>
                    <select class="status-select in-progress">
                        <option value="Production Ready">Production Ready</option>
                        <option value="In Progress" selected>In Progress</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Quality Check">Quality Check</option>
                    </select>
                </td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" /></td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%;">
                            <div class="progress-text">0%</div>
                        </div>
                    </div>
                </td>
                <td>
                    <select class="priority-select medium">
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </td>
                <td><textarea class="notes-input" placeholder="Enter pre-flight notes..."></textarea></td>
                <td><textarea class="notes-input" placeholder="Enter pre-cert notes..."></textarea></td>
                <td><textarea class="notes-input" placeholder="Enter NCMR notes..."></textarea></td>
                <td><input type="date" class="table-input" value="${dateString}" /></td>
                <td><input type="text" class="table-input" placeholder="Team Name" /></td>
                <td>
                    <button class="btn-small btn-danger" onclick="deleteAircraft(this)" title="Delete Aircraft">üóëÔ∏è</button>
                    <button class="btn-small" onclick="duplicateAircraft(this)" title="Duplicate Aircraft">üìã</button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            addEventListenersToRow(newRow);
            setupDragAndDrop(newRow);
            updateSummaryCards();
            saveDataToStorage();
            
            logSecurityEvent('AIRCRAFT_ADDED', { aircraftId: nextId });
            showSecurityNotification(`‚ûï Added aircraft ${nextId}`);
            
            newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Event listeners for rows
        function addEventListenersToRow(row) {
            // Checkbox
            const checkbox = row.querySelector('.row-checkbox');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    toggleRowSelection(this);
                });
            }
            
            // Operation checkboxes
            const operationCheckboxes = row.querySelectorAll('.operation-checkbox');
            operationCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    updateProgress(row);
                    saveDataToStorage();
                });
            });
            
            // Status select
            const statusSelect = row.querySelector('.status-select');
            if (statusSelect) {
                statusSelect.addEventListener('change', function() {
                    updateStatusStyle(this);
                    updateSummaryCards();
                    saveDataToStorage();
                });
            }
            
            // Priority select
            const prioritySelect = row.querySelector('.priority-select');
            if (prioritySelect) {
                prioritySelect.addEventListener('change', function() {
                    updatePriorityStyle(this);
                    applyRowVisualIndicators(row);
                    saveDataToStorage();
                });
            }
            
            // All inputs for auto-save
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (input.type === 'date') {
                        applyRowVisualIndicators(row);
                    }
                    saveDataToStorage();
                });
            });
        }

        function updateProgress(row) {
            const checkboxes = row.querySelectorAll('.operation-checkbox');
            const checkedBoxes = row.querySelectorAll('.operation-checkbox:checked');
            const progressBar = row.querySelector('.progress-fill');
            const progressText = row.querySelector('.progress-text');
            
            if (checkboxes.length > 0) {
                const progressPercent = Math.round((checkedBoxes.length / checkboxes.length) * 100);
                progressBar.style.width = progressPercent + '%';
                progressText.textContent = progressPercent + '%';
                
                // Add completion effects
                if (progressPercent === 100) {
                    progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                    row.classList.add('completed-row');
                    
                    // Show completion badge with animation
                    const aircraftIdCell = row.querySelector('td:nth-child(2)');
                    let badge = aircraftIdCell.querySelector('.completion-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'completion-badge';
                        badge.textContent = '‚úì Complete';
                        aircraftIdCell.appendChild(badge);
                        
                        logSecurityEvent('AIRCRAFT_COMPLETED', { 
                            aircraftId: row.querySelectorAll('.table-input')[0]?.value 
                        });
                        showSecurityNotification('üéâ Aircraft completed!');
                    }
                } else {
                    row.classList.remove('completed-row');
                    const badge = row.querySelector('.completion-badge');
                    if (badge) badge.remove();
                }
            }
            
            // Update visual indicators
            applyRowVisualIndicators(row);
        }

        // Smart auto-increment for aircraft IDs
        function getNextAircraftId() {
            const existingIds = Array.from(document.querySelectorAll('.table-input'))
                .map(input => input.value)
                .filter(id => id.match(/^[A-Z]{1,3}-\d{1,4}$/))
                .map(id => {
                    const parts = id.split('-');
                    return { prefix: parts[0], number: parseInt(parts[1]) };
                })
                .filter(obj => !isNaN(obj.number));
            
            if (existingIds.length === 0) {
                return 'AC-001';
            }
            
            // Group by prefix and find max number for each
            const prefixGroups = {};
            existingIds.forEach(obj => {
                if (!prefixGroups[obj.prefix]) {
                    prefixGroups[obj.prefix] = [];
                }
                prefixGroups[obj.prefix].push(obj.number);
            });
            
            // Use the most common prefix, or AC if none
            let mostCommonPrefix = 'AC';
            let maxCount = 0;
            for (const [prefix, numbers] of Object.entries(prefixGroups)) {
                if (numbers.length > maxCount) {
                    maxCount = numbers.length;
                    mostCommonPrefix = prefix;
                }
            }
            
            const maxNumber = Math.max(...(prefixGroups[mostCommonPrefix] || [0]));
            const nextNumber = maxNumber + 1;
            
            return `${mostCommonPrefix}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Visual indicators for rows
        function applyRowVisualIndicators(row) {
            // Clear existing classes
            row.classList.remove('overdue-row', 'critical-priority', 'high-priority');
            
            // Priority indicators
            const prioritySelect = row.querySelector('.priority-select');
            if (prioritySelect) {
                const priority = prioritySelect.value;
                if (priority === 'Critical') {
                    row.classList.add('critical-priority');
                } else if (priority === 'High') {
                    row.classList.add('high-priority');
                }
            }
            
            // Overdue indicators
            const deliveryInput = row.querySelector('input[type="date"]');
            if (deliveryInput && deliveryInput.value) {
                const deliveryDate = new Date(deliveryInput.value);
                const today = new Date();
                const progress = getRowProgress(row);
                
                if (deliveryDate < today && progress < 100) {
                    row.classList.add('overdue-row');
                }
            }
        }

        function applyVisualIndicators() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(applyRowVisualIndicators);
        }

        function getRowProgress(row) {
            const checkboxes = row.querySelectorAll('.operation-checkbox');
            const checkedBoxes = row.querySelectorAll('.operation-checkbox:checked');
            return checkboxes.length > 0 ? (checkedBoxes.length / checkboxes.length) * 100 : 0;
        }

        function createAircraftRow(data) {
            const newRow = document.createElement('tr');
            newRow.draggable = true;
            
            newRow.innerHTML = `
                <td><span class="drag-handle">‚ãÆ‚ãÆ</span><input type="checkbox" class="row-checkbox" /></td>
                <td><input type="text" class="table-input" value="${data.aircraftId}" /></td>
                <td>
                    <select class="table-input">
                        <option value="">Select Model</option>
                        <option value="PA-28-181" ${data.model === 'PA-28-181' ? 'selected' : ''}>PA-28-181</option>
                        <option value="PA-28-181 DX" ${data.model === 'PA-28-181 DX' ? 'selected' : ''}>PA-28-181 DX</option>
                        <option value="PA-44-180" ${data.model === 'PA-44-180' ? 'selected' : ''}>PA-44-180</option>
                        <option value="PA-46-350P" ${data.model === 'PA-46-350P' ? 'selected' : ''}>PA-46-350P</option>
                        <option value="PA-46-500" ${data.model === 'PA-46-500' ? 'selected' : ''}>PA-46-500</option>
                        <option value="PA-46-700" ${data.model === 'PA-46-700' ? 'selected' : ''}>PA-46-700</option>
                    </select>
                </td>
                <td>
                    <select class="status-select ${getStatusClass(data.status)}">
                        <option value="Production Ready" ${data.status === 'Production Ready' ? 'selected' : ''}>Production Ready</option>
                        <option value="In Progress" ${data.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="On Hold" ${data.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                        <option value="Quality Check" ${data.status === 'Quality Check' ? 'selected' : ''}>Quality Check</option>
                    </select>
                </td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" ${data.operations[0] ? 'checked' : ''} /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" ${data.operations[1] ? 'checked' : ''} /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" ${data.operations[2] ? 'checked' : ''} /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" ${data.operations[3] ? 'checked' : ''} /></td>
                <td class="operation-cell"><input type="checkbox" class="operation-checkbox" ${data.operations[4] ? 'checked' : ''} /></td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${calculateProgress(data.operations)}%;">
                            <div class="progress-text">${Math.round(calculateProgress(data.operations))}%</div>
                        </div>
                    </div>
                </td>
                <td>
                    <select class="priority-select ${data.priority.toLowerCase()}">
                        <option value="Critical" ${data.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                        <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${data.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                    </select>
                </td>
                <td><textarea class="notes-input" placeholder="Enter pre-flight notes...">${data.preFlightNotes}</textarea></td>
                <td><textarea class="notes-input" placeholder="Enter pre-cert notes...">${data.preCertNotes}</textarea></td>
                <td><textarea class="notes-input" placeholder="Enter NCMR notes...">${data.ncmrNotes}</textarea></td>
                <td><input type="date" class="table-input" value="${data.deliveryDate}" /></td>
                <td><input type="text" class="table-input" value="${data.team}" placeholder="Team Name" /></td>
                <td>
                    <button class="btn-small btn-danger" onclick="deleteAircraft(this)" title="Delete Aircraft">üóëÔ∏è</button>
                    <button class="btn-small" onclick="duplicateAircraft(this)" title="Duplicate Aircraft">üìã</button>
                </td>
            `;
            
            return newRow;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Production Ready': return 'production-ready';
                case 'In Progress': return 'in-progress';
                case 'On Hold': return 'on-hold';
                case 'Quality Check': return 'quality-check';
                default: return 'in-progress';
            }
        }

        function calculateProgress(operations) {
            const checked = operations.filter(op => op).length;
            return operations.length > 0 ? (checked / operations.length) * 100 : 0;
        }

        function updateLastSavedTime(timestamp = null) {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const time = timestamp ? new Date(timestamp) : new Date();
                lastUpdatedElement.textContent = `Dashboard Last Saved: ${time.toLocaleDateString()} at ${time.toLocaleTimeString()}`;
            }
        }

        // Data management functions
        function clearAllData() {
            if (confirm('Are you sure you want to clear all aircraft data? This action cannot be undone.')) {
                logSecurityEvent('DATA_CLEARED', { userConfirmed: true });
                localStorage.removeItem('aircraftDashboardData');
                showSecurityNotification('üóëÔ∏è All data cleared', true);
                setTimeout(() => location.reload(), 1000);
            } else {
                logSecurityEvent('DATA_CLEAR_CANCELLED', {});
            }
        }

        function exportBackup() {
            const savedData = localStorage.getItem('aircraftDashboardData');
            if (!savedData) {
                showSecurityNotification('‚ùå No data to export', true);
                return;
            }
            
            // Create backup with metadata
            const backup = {
                data: savedData,
                exportDate: new Date().toISOString(),
                version: '2.0',
                encrypted: true
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aircraft_dashboard_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            logSecurityEvent('BACKUP_EXPORTED', {});
            showSecurityNotification('üíæ Backup exported successfully');
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backup = JSON.parse(e.target.result);
                            
                            // Validate backup format
                            if (!backup.data) {
                                throw new Error('Invalid backup format');
                            }
                            
                            if (confirm('‚ö†Ô∏è Importing backup will replace all current data. Continue?')) {
                                localStorage.setItem('aircraftDashboardData', backup.data);
                                logSecurityEvent('BACKUP_IMPORTED', { 
                                    exportDate: backup.exportDate,
                                    version: backup.version 
                                });
                                showSecurityNotification('üì• Backup imported successfully');
                                setTimeout(() => location.reload(), 1000);
                            }
                        } catch (error) {
                            logSecurityEvent('BACKUP_IMPORT_FAILED', { error: error.message });
                            showSecurityNotification('‚ùå Invalid backup file format', true);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Drag and Drop Functions
        function setupDragAndDrop(row) {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);
        }

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            
            const dragHandle = this.querySelector('.drag-handle');
            if (dragHandle) {
                dragHandle.style.cursor = 'grabbing';
            }
        }

        function handleDragEnter(e) {
            if (draggedRow !== this) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedRow !== this) {
                const tbody = this.parentNode;
                const draggedIndex = Array.from(tbody.children).indexOf(draggedRow);
                const targetIndex = Array.from(tbody.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    tbody.insertBefore(draggedRow, this.nextSibling);
                } else {
                    tbody.insertBefore(draggedRow, this);
                }
                
                saveDataToStorage();
                logSecurityEvent('ROW_REORDERED', { from: draggedIndex, to: targetIndex });
                
                // Show success feedback
                this.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    this.style.backgroundColor = '';
                }, 1000);
            }
            
            return false;
        }

        function handleDragEnd(e) {
            // Clean up all visual feedback
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.classList.remove('dragging', 'drag-over');
                const dragHandle = row.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.style.cursor = 'grab';
                }
            });
            
            draggedRow = null;
        }
    </script>
</body>
</html>
